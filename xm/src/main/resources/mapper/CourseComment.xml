<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.xm.mapper.CourseCommentMapper">

    <!-- 插入评论 -->
    <insert id="insertComment" parameterType="com.example.xm.entity.CourseComment">
        INSERT INTO course_comment (course_id, user_id,username, content, parent_id, like_count, role, create_time, is_deleted)
        VALUES (#{courseId}, #{userId},#{username}, #{content}, #{parentId}, #{likeCount}, #{role}, NOW(), false)
    </insert>

    <!-- 查询课程下所有评论 -->
    <select id="getCommentsByCourseId" resultType="com.example.xm.entity.CourseComment">
        SELECT *
        FROM course_comment
        WHERE course_id = #{courseId}
          AND is_deleted = false
        ORDER BY create_time DESC
    </select>

    <!-- 分页查询课程下的评论 -->
    <select id="getPagedCommentsByCourseId" resultType="com.example.xm.entity.CourseComment">
        SELECT *
        FROM course_comment
        WHERE course_id = #{courseId}
          AND is_deleted = false
          AND (parent_id IS NULL OR parent_id = 0)
        ORDER BY create_time DESC
    </select>

    <!-- 删除自己的评论（逻辑删除） -->
    <update id="deleteComment">
        UPDATE course_comment
        SET is_deleted = true
        WHERE id = #{commentId} AND user_id = #{userId}
    </update>

    <!-- 点赞 +1 -->
    <update id="incrementLike">
        UPDATE course_comment
        SET like_count = like_count + 1
        WHERE id = #{commentId}
    </update>

    <!-- 获取评论详情 -->
    <select id="getCommentById" resultType="com.example.xm.entity.CourseComment">
        SELECT *
        FROM course_comment
        WHERE id = #{commentId}
    </select>
    <select id="getRepliesByParentId" resultType="com.example.xm.entity.CourseComment">
        SELECT *
        FROM course_comment
        WHERE parent_id = #{parentId}
          AND is_deleted = false
        ORDER BY create_time ASC
    </select>
</mapper>